<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết sản phẩm - Flower Shop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/home.css}">
    <link rel="stylesheet" href="/css/detail.css">
    <link rel="stylesheet" href="/css/reviews-fix.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <a href="/home">
                <h1>FIAMA</h1>
            </a>
        </div>
        <nav class="nav-links">
            <a href="/home">Trang chủ</a>
            <a href="/product">Sản phẩm</a>
            <a href="#" th:if="${!isAdmin}">Liên hệ</a>
            <a href="/admin" th:if="${isAdmin}">Admin</a>
        </nav>
        <div class="utility-nav">
            <div th:if="${isLoggedIn}" class="user-dropdown">
                <a href="#" class="user-link">
                    <i class="fas fa-user"></i>
                    <span th:text="${userDisplayName}">User</span>
                </a>
                <div class="dropdown-menu">
                    <a href="/account">Tài khoản</a>
                    <a href="/logout">Đăng xuất</a>
                </div>
            </div>
            <a th:if="${!isLoggedIn}" href="/login" class="user-link">
                <i class="fas fa-user"></i>
                <span>Đăng nhập</span>
            </a>
            <a href="/cart" class="cart-icon-wrapper">
                <i class="fas fa-shopping-bag"></i>
                <span class="cart-count">0</span>
            </a>
        </div>
    </header>

    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <div class="container">
            <a href="/home">Trang chủ</a>
            <span class="separator">›</span>
            <a href="/product">Sản phẩm</a>
            <span class="separator">›</span>
            <span class="current">Chi tiết sản phẩm</span>
        </div>
    </div>

    <!-- Product Detail Section -->
    <section class="product-detail-section">
        <div class="container">
            <div class="product-detail-grid">
                <!-- Product Images -->
                <div class="product-images" th:if="${product != null}">
                    <div class="main-image">
                        <img id="mainProductImage" th:src="${product.imageUrl}" th:alt="${product.name}" alt="Product">
                    </div>
                    <div class="thumbnail-images">
                        <img th:src="${product.imageUrl}" alt="Thumbnail 1" class="thumbnail active" data-index="0">
                        <img th:src="${product.imageUrl}" alt="Thumbnail 2" class="thumbnail" data-index="1">
                        <img th:src="${product.imageUrl}" alt="Thumbnail 3" class="thumbnail" data-index="2">
                        <img th:src="${product.imageUrl}" alt="Thumbnail 4" class="thumbnail" data-index="3">
                    </div>
                </div>

                <!-- Product Info -->
                <div class="product-info-detail" th:if="${product != null}" 
                     th:attr="data-product-id=${product.id}, data-product-name=${product.name}, data-product-price=${product.price}, data-product-image=${product.imageUrl}, data-product-stock=${product.stockQuantity}">
                    <h1 class="product-title" id="productTitle" th:text="${product.name}">Cây Hoa Hồng Hồng</h1>
                    
                    <div class="price-rating-row">
                        <div class="product-price-wrapper">
                            <span class="product-price" id="productPrice" th:text="'₫' + ${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')}">₫420,000</span>
                        </div>
                        <div class="product-rating">
                            <div class="rating-stars">
                                <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                    <i th:if="${product.isStarFilled(i)}" class="fas fa-star filled"></i>
                                    <i th:if="${product.isStarHalfFilled(i)}" class="fas fa-star-half-alt"></i>
                                    <i th:if="${product.isStarEmpty(i)}" class="far fa-star"></i>
                                </th:block>
                            </div>
                            <span class="rating-count" th:text="'(' + ${product.getReviewCount()} + ' đánh giá)'">(0 đánh giá)</span>
                        </div>
                    </div>

                    <div class="product-short-description" th:if="${product != null}">
                        <p th:if="${product.description != null && !#strings.isEmpty(product.description)}" th:text="${product.description}">Hoa tươi cao cấp được chọn lọc kỹ lưỡng từ vườn ươm uy tín.</p>
                        <p th:if="${product.description == null || #strings.isEmpty(product.description)}">Hoa tươi cao cấp được chọn lọc kỹ lưỡng từ vườn ươm uy tín. Mỗi bông hoa đều được chăm sóc cẩn thận để đảm bảo độ tươi và vẻ đẹp hoàn hảo.</p>
                    </div>

                    <div class="product-meta">
                        <div class="meta-item">
                            <span class="meta-label">Danh mục:</span>
                            <span class="meta-value">Hoa hồng</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Tình trạng:</span>
                            <span class="meta-value stock-status" id="stockStatus" 
                                  th:if="${product.stockQuantity > 0}" 
                                  th:text="'Còn hàng (' + ${product.stockQuantity} + ' sản phẩm)'" 
                                  style="color: #4caf50;">Còn hàng</span>
<!--                            <span class="meta-value stock-status" id="stockStatus" -->
<!--                                  th:if="${product.stockQuantity == 0 || product.stockQuantity == null}" -->
<!--                                  th:text="'Hết hàng'" -->
<!--                                  style="color: #f44336;">Hết hàng</span>-->
                        </div>
                    </div>

                    <div class="quantity-cart-row">
                        <div class="quantity-section">
                            <label class="quantity-label">Số lượng:</label>
                            <div class="quantity-selector-detail">
                                <button class="qty-btn-detail minus-btn-detail">-</button>
                                <input type="number" id="productQuantity" value="1" min="1" th:max="${product.stockQuantity}" class="qty-input-detail">
                                <button class="qty-btn-detail plus-btn-detail">+</button>
                            </div>
                        </div>
                        <button class="add-to-cart-btn-detail" id="addToCartBtn" th:disabled="${product.stockQuantity == 0 || product.stockQuantity == null}">
                            <i class="fas fa-shopping-cart"></i>
                            Thêm vào giỏ hàng
                        </button>
                    </div>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="product-tabs" id="reviews" th:if="${product != null}">
                <!-- Flash Messages (Hidden - will be shown as toast, only for review-related messages) -->
                <div th:if="${success != null and !#strings.contains(success, 'giỏ hàng') and !#strings.contains(success, 'thêm vào giỏ')}" 
                     id="flashSuccess" 
                     style="display: none;" 
                     th:text="${success}"></div>
                <div th:if="${error != null and !#strings.contains(error, 'giỏ hàng') and !#strings.contains(error, 'thêm vào giỏ')}" 
                     id="flashError" 
                     style="display: none;" 
                     th:text="${error}"></div>
                <div class="reviews-container">
                    <!-- Left Column: Reviews List -->
                    <div class="reviews-list-column">
                        <h3 class="reviews-section-title">Đánh giá từ khách hàng</h3>
                        <div th:if="${reviews == null || reviews.isEmpty()}" class="no-reviews">
                            <p>Chưa có đánh giá nào cho sản phẩm này. Hãy là người đầu tiên đánh giá!</p>
                        </div>
                        <div th:each="review : ${reviews}" class="review-item" th:if="${review != null}" th:attr="data-review-id=${review.id}">
                            <!-- Display Mode -->
                            <div class="review-display" th:id="'review-display-' + ${review.id}">
                                <div class="review-item-header">
                                    <div class="reviewer-info">
                                        <img class="reviewer-avatar-img" 
                                             th:src="${'https://ui-avatars.com/api/?name=' + (review.account != null ? #strings.replace(review.account.getDisplayName(), ' ', '+') : 'User') + '&size=60&background=E95473&color=fff&bold=true'}" 
                                             th:alt="${review.account != null ? review.account.getDisplayName() : 'User'}"
                                             alt="Avatar">
                                        <div class="reviewer-details">
                                            <div class="reviewer-name-wrapper">
                                                <h4 class="reviewer-name" th:text="${review.account != null ? review.account.getDisplayName() : 'Anonymous'}">Anonymous</h4>
                                                <!-- Edit/Delete Buttons - Only show if user owns this review -->
                                                <div class="review-actions" th:if="${currentAccount != null and review.account != null and (review.account.id == currentAccount.id)}">
                                                    <button type="button" class="edit-review-btn" th:attr="data-review-id=${review.id}">
                                                        <i class="fas fa-edit"></i>
                                                        <span class="tooltip-text">Chỉnh sửa</span>
                                                    </button>
                                                    <button type="button" class="delete-review-btn" th:attr="data-review-id=${review.id}, data-product-id=${product.id}">
                                                        <i class="fas fa-trash"></i>
                                                        <span class="tooltip-text">Xóa</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="review-stars" th:if="${review.rating != null}">
                                                <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                                    <i th:if="${review.rating >= i}" class="fas fa-star filled"></i>
                                                    <i th:if="${review.rating < i}" class="far fa-star"></i>
                                                </th:block>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="review-date-pill" th:if="${review.reviewDate != null}" th:text="${#temporals.format(review.reviewDate, 'dd/MM/yyyy')}">15/11/2024</span>
                                </div>
                                <p class="review-text" th:text="${review.comment != null ? review.comment : ''}">Hoa rất đẹp và tươi, giao hàng nhanh. Rất hài lòng!</p>
                            </div>
                            
                            <!-- Edit Mode (Hidden by default) -->
                            <div class="review-edit" th:id="'review-edit-' + ${review.id}" style="display: none;">
                                <form th:attr="data-review-id=${review.id}, data-product-id=${product.id}" class="edit-review-form">
                                    <div class="form-group">
                                        <label class="form-label">Đánh giá:</label>
                                        <div class="rating-input">
                                            <input type="hidden" th:attr="name='rating', id='editRating-' + ${review.id}" th:value="${review.rating != null ? review.rating : 5}" required>
                                            <div class="rating-stars-input edit-rating-stars" th:attr="data-review-id=${review.id}">
                                                <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                                    <i th:if="${review.rating != null && review.rating >= i}" class="fas fa-star filled active" th:attr="data-rating=${i}"></i>
                                                    <i th:if="${review.rating == null || review.rating < i}" class="far fa-star" th:attr="data-rating=${i}"></i>
                                                </th:block>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Bình luận:</label>
                                        <textarea class="form-textarea edit-comment" th:attr="name='comment', id='editComment-' + ${review.id}" rows="4" required th:text="${review.comment != null ? review.comment : ''}"></textarea>
                                    </div>
                                    <div class="edit-form-actions">
                                        <button type="submit" class="save-review-btn">Lưu</button>
                                        <button type="button" class="cancel-edit-btn" th:attr="data-review-id=${review.id}">Hủy</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Add Review Form -->
                    <div class="add-review-column">
                        <h3 class="add-review-title">Thêm đánh giá</h3>
                        <form id="addReviewForm" class="add-review-form" th:action="@{/product/detail/{id}/review(id=${product.id})}" method="post">
                            <div class="form-group">
                                <label class="form-label">Đánh giá của bạn:</label>
                                <div class="rating-input">
                                    <!-- value="0" -->
                                    <input type="hidden" name="rating" id="reviewRating" value="0" required>
                                    <div class="rating-stars-input add-rating-stars">
                                        <!-- TẤT CẢ SAO RỖNG -->
                                        <i class="far fa-star" data-rating="1"></i>
                                        <i class="far fa-star" data-rating="2"></i>
                                        <i class="far fa-star" data-rating="3"></i>
                                        <i class="far fa-star" data-rating="4"></i>
                                        <i class="far fa-star" data-rating="5"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="reviewComment">Bình luận:</label>
                                <textarea id="reviewComment" name="comment" class="form-textarea" placeholder="Nhập bình luận..." rows="6" required></textarea>
                            </div>
                            <button type="submit" class="submit-review-btn">GỬI ĐÁNH GIÁ</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Toast Notification -->
    <div class="toast" id="toast" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span></span>
    </div>

    <!-- Delete Review Confirmation Modal -->
    <div class="delete-confirm-modal" id="deleteConfirmModal">
        <div class="delete-confirm-modal-content">
            <div class="delete-confirm-modal-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Xác nhận xóa đánh giá</h3>
            </div>
            <div class="delete-confirm-modal-body">
                <p>Bạn có chắc chắn muốn xóa đánh giá này? Hành động này không thể hoàn tác.</p>
            </div>
            <div class="delete-confirm-modal-footer">
                <button type="button" class="cancel-delete-btn" id="cancelDeleteBtn">Hủy</button>
                <button type="button" class="confirm-delete-btn" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <!-- Column 1: Opening Time -->
            <div class="footer-column">
                <h4>Giờ mở cửa</h4>
                <div class="footer-opening-time">
                    <div class="opening-time-row">
                        <span class="opening-day">Thứ 2 - Thứ 6:</span>
                        <span class="opening-hours">8:00 - 22:00</span>
                    </div>
                    <div class="opening-time-row">
                        <span class="opening-day">Thứ 7:</span>
                        <span class="opening-hours">9:00 - 20:00</span>
                    </div>
                    <div class="opening-time-row">
                        <span class="opening-day">Chủ nhật:</span>
                        <span class="opening-hours">14:00 - 18:00</span>
                    </div>
                    <p class="footer-holiday">Chúng tôi làm việc cả ngày lễ</p>
                </div>
            </div>
            
            <!-- Column 2: Contact -->
            <div class="footer-column">
                <h4>Liên hệ</h4>
                <div class="footer-contact-info">
                    <p><i class="fas fa-map-marker-alt"></i> Thành phố Hồ Chí Minh, Việt Nam</p>
                    <p><i class="fas fa-phone"></i> +84 123 456 789</p>
                    <p><i class="fas fa-envelope"></i> info@fiama.com</p>
                </div>
            </div>
            
            <!-- Column 3: Central Section with Logo, Social, Apps -->
            <div class="footer-column footer-center-column">
                <div class="footer-logo-center">FIAMA</div>
                <div class="footer-social-icons">
                    <a href="#" class="social-icon" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social-icon" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-icon" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="social-icon" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                </div>
                <div class="footer-app-buttons">
                    <a href="#" class="app-button app-store">
                        <i class="fab fa-apple"></i>
                        <span>Tải từ APP STORE</span>
                    </a>
                    <a href="#" class="app-button google-play">
                        <i class="fab fa-google-play"></i>
                        <span>Tải từ GOOGLE PLAY</span>
                    </a>
                </div>
            </div>
            
            <!-- Column 4: My Account -->
            <div class="footer-column">
                <h4>Tài khoản của tôi</h4>
                <ul>
                    <li><a href="/account">Tài khoản của tôi</a></li>
                    <li><a href="/cart">Giỏ hàng</a></li>
                    <li><a href="/account#orders">Lịch sử đơn hàng</a></li>
                </ul>
            </div>
            
            <!-- Column 5: Customer Service -->
            <div class="footer-column">
                <h4>Dịch vụ khách hàng</h4>
                <ul>
                    <li><a href="#">Điều khoản sử dụng</a></li>
                    <li><a href="#">Chính sách bảo mật</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <script src="/js/cart-utils.js"></script>
    <script src="/js/detail.js"></script>
</body>
</html>

