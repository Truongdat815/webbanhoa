<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FIAMA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/home.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-header.with-toggle {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .chart-header.with-toggle h2 {
            margin-bottom: 4px;
        }

        .chart-toggle {
            display: inline-flex;
            gap: 4px;
            padding: 4px;
            border-radius: 999px;
            background: #f1f5f9;
        }

        .chart-toggle button {
            border: none;
            background: transparent;
            color: #475569;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chart-toggle button:hover {
            color: #0f172a;
        }

        .chart-toggle button.active {
            background: #ffffff;
            color: #0f172a;
            box-shadow: 0 1px 5px rgba(15, 23, 42, 0.12);
        }

        .chart-legend {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chart-legend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #475569;
        }

        .chart-legend-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .chart-legend-value {
            font-weight: 600;
            color: #0f172a;
        }

        .chart-legend-sub {
            display: block;
            color: #94a3b8;
            font-size: 12px;
            margin-top: 2px;
        }

        /* Đảm bảo pie chart luôn là hình tròn hoàn hảo - override mọi CSS khác */
        .pie-chart-wrapper {
            width: 320px;
            height: 320px;
            max-width: 100%;
            margin: 0 auto;
            position: relative;
            box-sizing: border-box;
        }
        
        .pie-chart-wrapper canvas,
        .pie-chart-container canvas,
        #revenuePieChart {
            width: 320px !important;
            height: 320px !important;
            max-width: 320px !important;
            max-height: 320px !important;
            min-width: 320px !important;
            min-height: 320px !important;
            display: block !important;
            box-sizing: border-box !important;
        }
    </style>
</head>
<body class="admin-page">
    <!-- Admin Header -->
    <header class="admin-header">
        <div class="admin-header-content">
            <div class="logo">
                <a href="/admin">
                    <h1>FIAMA</h1>
                    <span class="admin-badge">ADMIN</span>
                </a>
            </div>
            <div class="admin-user-info">
                <div class="user-dropdown">
                    <a href="#" class="user-link">
                        <i class="fas fa-user-shield"></i>
                        <span th:text="${userDisplayName}">Admin</span>
                    </a>
                    <div class="dropdown-menu">
                        <a href="/logout">Đăng xuất</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Admin Main Content -->
    <main class="admin-main">
        <div class="admin-container">
            <!-- Sidebar -->
            <aside class="admin-sidebar">
                <div class="sidebar-header">
                    <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
                </div>
                <nav class="sidebar-nav">
                    <a href="/admin" class="nav-item active">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/admin/products" class="nav-item">
                        <i class="fas fa-box"></i>
                        <span>Sản phẩm</span>
                    </a>
                    <a href="/admin/orders" class="nav-item">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Đơn hàng</span>
                    </a>
                    <a href="/admin/accounts" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span>Tài khoản</span>
                    </a>
                </nav>
            </aside>

            <!-- Content Area -->
            <div class="admin-content">
                <div class="content-header">
                    <h1>Dashboard</h1>
                    <p>Quản lý hệ thống</p>
                </div>

                <div class="dashboard-grid">
                    <div class="stats-chart-card">
                        <div class="chart-header">
                            <h2>Thống kê tổng quan</h2>
                            <span>Số lượng sản phẩm và tài khoản hiện tại</span>
                        </div>
                        <canvas id="totalsChart"></canvas>
                    </div>
                    <div class="stats-chart-card pie-chart-container">
                        <div class="chart-header">
                            <h2>Doanh thu theo sản phẩm</h2>
                            <span>Top 12 sản phẩm có doanh thu cao nhất</span>
                        </div>
                        <div class="pie-chart-wrapper">
                            <canvas id="revenuePieChart"></canvas>
                        </div>
                        <div class="chart-legend" id="revenueLegend"></div>
                    </div>
                </div>

                <div class="stats-chart-card">
                    <div class="chart-header with-toggle">
                        <div>
                            <h2>Đơn hàng</h2>
                            <span>Chọn phạm vi thời gian để so sánh</span>
                        </div>
                        <div class="chart-toggle" id="ordersRangeToggle">
                            <button type="button" data-range="day">7 ngày</button>
                            <button type="button" data-range="week">8 tuần</button>
                            <button type="button" data-range="month" class="active">4 tháng</button>
                        </div>
                    </div>
                    <canvas id="ordersTrendChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Admin Footer -->
    <footer class="admin-footer">
        <div class="admin-footer-content">
            <p>&copy; 2025 FIAMA Admin Panel. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/admin.js"></script>
    <script th:inline="javascript">
    window.__DASHBOARD__ = /*[[${dashboardStats}]]*/ {};
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        const numberFormatter = new Intl.NumberFormat('vi-VN');
        const currencyFormatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

        let stats = window.__DASHBOARD__ || {};
        let totals = stats.totals || { products: 0, accounts: 0, orders: 0, revenue: 0 };
        let totalsChartData = normalizeTotalsChartData(stats.totalsChart, totals);
        let revenueBreakdown = Array.isArray(stats.revenueBreakdown) ? stats.revenueBreakdown : [];
        let trends = stats.trends || {};
        let currentRange = 'month';

        const totalsCtx = document.getElementById('totalsChart')?.getContext('2d');
        const revenueCtx = document.getElementById('revenuePieChart')?.getContext('2d');
        const ordersCtx = document.getElementById('ordersTrendChart')?.getContext('2d');
        const revenueLegend = document.getElementById('revenueLegend');
        const rangeButtons = document.querySelectorAll('#ordersRangeToggle button');

        if (!totalsCtx || !revenueCtx || !ordersCtx) {
            return;
        }

        const valueLabelPlugin = {
            id: 'valueLabelPlugin',
            afterDatasetsDraw(chart) {
                const { ctx } = chart;
                chart.data.datasets.forEach(dataset => {
                    const meta = chart.getDatasetMeta(0);
                    meta.data.forEach((bar, index) => {
                        const value = dataset.data[index];
                        if (value === undefined || value === null) {
                            return;
                        }
                        ctx.save();
                        ctx.fillStyle = '#1e293b';
                        ctx.font = 'normal 14px Inter, system-ui, -apple-system, "Segoe UI", sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        ctx.setTransform(1, 0, 0, 1, 0, 0); // Đảm bảo không có transform nghiêng
                        ctx.fillText(numberFormatter.format(value), bar.x, bar.y - 8);
                        ctx.restore();
                    });
                });
            }
        };


        const totalsChart = new Chart(totalsCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderRadius: 0,
                    borderSkipped: false,
                    maxBarThickness: 72
                }]
            },
            options: {
                maintainAspectRatio: false,
                layout: { padding: { top: 20, right: 16, left: 8, bottom: 8 } },
                plugins: { legend: { display: false } },
                animation: { duration: 600, easing: 'easeOutQuart' },
                scales: {
                    x: { 
                        grid: { display: false, drawBorder: false }, 
                        ticks: { 
                            color: '#475569', 
                            font: { 
                                family: 'Inter, system-ui, -apple-system, "Segoe UI", sans-serif',
                                size: 13,
                                weight: 'normal',
                                style: 'normal'
                            }
                        } 
                    },
                    y: { beginAtZero: true, ticks: { precision: 0, color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.2)', drawBorder: false } }
                }
            },
            plugins: [valueLabelPlugin]
        });

        const revenueChart = new Chart(revenueCtx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: []
                }]
            },
            options: {
                maintainAspectRatio: true,
                aspectRatio: 1,
                responsive: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label(context) {
                                const item = revenueBreakdown[context.dataIndex];
                                if (!item) {
                                    return '';
                                }
                                const revenue = currencyFormatter.format(Number(item.revenue) || 0);
                                const quantity = numberFormatter.format(item.quantity ?? 0);
                                return `${item.name}: ${revenue} (${quantity} sản phẩm)`;
                            }
                        }
                    }
                }
            }
        });

        const trendChart = new Chart(ordersCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderColor: '#f5576c',
                    backgroundColor: 'rgba(245, 87, 108, 0.15)',
                    tension: 0.35,
                    fill: true,
                    borderWidth: 3,
                    pointRadius: 3.5,
                    pointHoverRadius: 5,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#f5576c',
                    pointBorderWidth: 2
                }]
            },
            options: {
                maintainAspectRatio: false,
                layout: { padding: { top: 8, right: 16, left: 8, bottom: 8 } },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label(context) {
                                return `${context.parsed.y} đơn hàng`;
                            }
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false, drawBorder: false }, ticks: { color: '#64748b', font: { weight: 600 } } },
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0, color: '#94a3b8' },
                        grid: { color: 'rgba(148,163,184,0.2)', drawBorder: false }
                    }
                }
            }
        });

        const totalsColors = [
            '#8B5CF6', // Màu tím đẹp cho Sản phẩm
            '#06B6D4'  // Màu xanh cyan đẹp cho Tài khoản
        ];
        const pieColors = ['#6366F1', '#F97316', '#22C55E', '#0EA5E9', '#F43F5E', '#A855F7', '#14B8A6', '#F59E0B', '#3B82F6', '#EC4899', '#84CC16', '#8B5CF6'];

        function normalizeTotalsChartData(dataset, fallback) {
            const labels = dataset && Array.isArray(dataset.labels) && dataset.labels.length
                ? dataset.labels
                : ['Sản phẩm', 'Tài khoản'];
            const values = dataset && Array.isArray(dataset.values) && dataset.values.length
                ? dataset.values
                : [fallback.products ?? 0, fallback.accounts ?? 0];
            return {
                labels,
                values: values.map(value => Number(value) || 0)
            };
        }

        function updateTotalsChart(data) {
            const normalized = normalizeTotalsChartData(data, totals);
            totalsChart.data.labels = normalized.labels;
            totalsChart.data.datasets[0].data = normalized.values;
            totalsChart.data.datasets[0].backgroundColor = normalized.labels.map((_, index) => {
                return totalsColors[index % totalsColors.length];
            });
            totalsChart.update();
        }

        function renderRevenueLegend(breakdown, colors) {
            if (!revenueLegend) {
                return;
            }
            revenueLegend.innerHTML = '';
            if (!breakdown || !breakdown.length) {
                revenueLegend.innerHTML = '<span class="chart-legend-sub">Chưa có dữ liệu doanh thu.</span>';
                return;
            }
            const totalRevenue = breakdown.reduce((sum, item) => sum + (Number(item.revenue) || 0), 0);
            breakdown.forEach((item, index) => {
                const revenue = Number(item.revenue) || 0;
                const percent = totalRevenue > 0 ? (revenue / totalRevenue) * 100 : 0;
                const percentRounded = percent >= 10 ? Math.round(percent) : Math.round(percent * 10) / 10;
                const percentLabel = Number.isInteger(percentRounded) ? percentRounded.toString() : percentRounded.toFixed(1);
                const legendItem = document.createElement('div');
                legendItem.className = 'chart-legend-item';
                legendItem.innerHTML = `
                    <div class="chart-legend-left">
                        <span class="chart-legend-color" style="background:${colors[index % colors.length]};"></span>
                        <div>
                            <span>${item.name}</span>
                            <span class="chart-legend-sub">${numberFormatter.format(item.quantity ?? 0)} sản phẩm • ${currencyFormatter.format(revenue)}</span>
                        </div>
                    </div>
                    <span class="chart-legend-value">${percentLabel}%</span>
                `;
                revenueLegend.appendChild(legendItem);
            });
        }

        function updateRevenueChart(breakdown) {
            revenueBreakdown = Array.isArray(breakdown) ? breakdown : [];
            if (!revenueBreakdown.length) {
                revenueChart.data.labels = ['Không có dữ liệu'];
                revenueChart.data.datasets[0].data = [1];
                revenueChart.data.datasets[0].backgroundColor = ['#E2E8F0'];
                renderRevenueLegend([], []);
                revenueChart.update();
                return;
            }
            const labels = revenueBreakdown.map(item => item.name ?? 'Sản phẩm');
            const values = revenueBreakdown.map(item => Number(item.revenue) || 0);
            const colors = labels.map((_, index) => pieColors[index % pieColors.length]);
            revenueChart.data.labels = labels;
            revenueChart.data.datasets[0].data = values;
            revenueChart.data.datasets[0].backgroundColor = colors;
            revenueChart.update();
            renderRevenueLegend(revenueBreakdown, colors);
        }

        function setActiveRange(range) {
            rangeButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === range);
            });
        }

        function getSeries(range) {
            if (!trends) {
                return null;
            }
            const series = trends[range];
            if (series && Array.isArray(series.labels) && Array.isArray(series.values)) {
                return series;
            }
            return null;
        }

        function updateTrendChart(range) {
            let series = getSeries(range);
            if (!series && range !== 'month' && getSeries('month')) {
                currentRange = 'month';
                range = 'month';
                setActiveRange('month');
                series = getSeries('month');
            }
            if (!series) {
                trendChart.data.labels = [''];
                trendChart.data.datasets[0].data = [0];
            } else {
                trendChart.data.labels = Array.isArray(series.labels) ? series.labels : [];
                trendChart.data.datasets[0].data = Array.isArray(series.values)
                    ? series.values.map(value => Number(value) || 0)
                    : [];
            }
            trendChart.update();
        }

        rangeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const range = btn.dataset.range;
                if (!range || range === currentRange) {
                    return;
                }
                currentRange = range;
                setActiveRange(currentRange);
                updateTrendChart(currentRange);
            });
        });

        setActiveRange(currentRange);
        updateTotalsChart(totalsChartData);
        updateRevenueChart(revenueBreakdown);
        updateTrendChart(currentRange);

        try {
            const res = await fetch('/admin/api/dashboard');
            if (res.ok) {
                const data = await res.json();
                stats = data;
                window.__DASHBOARD__ = data;
                totals = data.totals || totals;
                totalsChartData = normalizeTotalsChartData(data.totalsChart, totals);
                revenueBreakdown = Array.isArray(data.revenueBreakdown) ? data.revenueBreakdown : revenueBreakdown;
                trends = data.trends || trends;
                updateTotalsChart(totalsChartData);
                updateRevenueChart(revenueBreakdown);
                updateTrendChart(currentRange);
                setActiveRange(currentRange);
            }
        } catch (error) {
            console.error('Không thể tải dữ liệu dashboard', error);
        }
    });
    </script>
</body>
</html>

