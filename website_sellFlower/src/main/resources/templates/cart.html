<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giỏ hàng - FIAMA</title>

    <!-- CSRF meta chỉ render nếu token có sẵn -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}" />
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}" />

    <link rel="stylesheet" th:href="@{/css/cart.css}" />
    <link rel="stylesheet" th:href="@{/css/home.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <style>
        /* Additional styles for loading state */
        .checkout-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .checkout-btn i.fa-spinner { margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fa-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="logo">
        <a th:href="@{/home}"><h1>FIAMA</h1></a>
    </div>

    <nav class="nav-links">
        <a th:href="@{/home}">Trang chủ</a>
        <a th:href="@{/product}">Sản phẩm</a>
        <a href="#">Liên hệ</a>
    </nav>

    <div class="utility-nav">
        <div th:if="${isLoggedIn}" class="user-dropdown">
            <a href="#" class="user-link"><i class="fas fa-user"></i><span th:text="${userDisplayName}">User</span></a>
            <div class="dropdown-menu">
                <a th:href="@{/account}">Tài khoản</a>
                <a th:href="@{/logout}">Đăng xuất</a>
            </div>
        </div>

        <!-- Safe check for not logged in -->
        <a th:if="${isLoggedIn != true}" th:href="@{/login}" class="user-link">
            <i class="fas fa-user"></i>
            <span>Đăng nhập</span>
        </a>

        <a th:href="@{/cart}" class="cart-icon-wrapper">
            <i class="fas fa-shopping-bag"></i>
            <span class="cart-count" id="cartCount">0</span>
        </a>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="cart-container">
        <h1 class="cart-title">Giỏ hàng của tôi</h1>

        <!-- Empty Cart State (no Thymeleaf conditional that uses null) -->
        <div class="cart-empty" id="emptyCart" style="display:none;">
            <div class="empty-cart-icon"><i class="fas fa-shopping-bag"></i></div>
            <p class="empty-cart-message">Giỏ hàng trống</p>
            <a th:href="@{/home}" class="continue-browsing">Tiếp tục mua sắm</a>
        </div>

        <!-- Cart with Items -->
        <div class="cart-with-items" id="cartWithItems" style="display:none;">
            <div class="cart-items-section">
                <div class="cart-items" id="cartItemsList">
                    <!-- JS will inject items here -->
                </div>

                <div class="cart-actions">
                    <button class="update-cart-btn" id="updateCartBtn">Cập nhật giỏ hàng</button>
                </div>
            </div>

            <div class="cart-summary">
                <h2 class="summary-title">Tổng giỏ hàng</h2>
                <div class="summary-row"><span>Tạm tính</span><span class="subtotal">₫0</span></div>
                <div class="summary-row"><span>Phí vận chuyển</span><span class="shipping">₫15.000</span></div>
                <div class="summary-row"><span>Thuế VAT</span><span class="vat">₫0</span></div>
                <div class="summary-divider"></div>
                <div class="summary-row total-row"><span>Tổng cộng</span><span class="total">₫0</span></div>
                <button class="checkout-btn" id="checkoutBtn"><span>Đặt hàng</span></button>
            </div>
        </div>
    </div>
</main>

<!-- Footer (kept short to avoid parse risk) -->
<footer class="footer">
    <div class="footer-content">
        <div class="footer-column"><h4>Giờ mở cửa</h4><p>Thứ 2 - Thứ 6: 8:00 - 22:00</p></div>
        <div class="footer-column"><h4>Liên hệ</h4><p><i class="fas fa-phone"></i> +84 123 456 789</p></div>
        <div class="footer-column footer-center-column"><div class="footer-logo-center">FIAMA</div></div>
    </div>
</footer>

<!-- Toast -->
<div class="toast" id="toast" style="display:none;"><i class="fas fa-check-circle"></i><span>Đã cập nhật!</span></div>

<!-- External scripts (use th:src so Thymeleaf resolves location) -->
<script th:src="@{/js/cart-utils.js}"></script>
<script th:src="@{/js/cart.js}"></script>
</body>
</html>