<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giỏ hàng - FIAMA</title>

    <!-- CSRF meta chỉ render nếu token có sẵn -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}" />
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}" />

    <link rel="stylesheet" th:href="@{/css/cart.css}" />
    <link rel="stylesheet" th:href="@{/css/home.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <style>
        /* Additional styles for loading state */
        .checkout-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .checkout-btn i.fa-spinner { margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fa-spin { animation: spin 1s linear infinite; }
        .checkout-info { margin-bottom: 20px; display: flex; flex-direction: column; gap: 12px; }
        .checkout-info h3 { font-size: 16px; font-weight: 600; color: #2c2c2c; margin-bottom: 4px; }
        .checkout-info label { font-size: 13px; font-weight: 500; color: #555; }
        .checkout-info input,
        .checkout-info textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 44px;
        }
        .checkout-info input:focus,
        .checkout-info textarea:focus {
            border-color: #e95473;
            outline: none;
            box-shadow: 0 0 0 2px rgba(233, 84, 115, 0.15);
        }
        .checkout-error {
            color: #e95473;
            font-size: 13px;
        }
        /* Confirm Modal */
        .confirm-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .confirm-modal.show { display: flex; }
        .confirm-modal-content {
            width: 94%;
            max-width: 520px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
            animation: modalIn .18s ease;
        }
        @keyframes modalIn { from { transform: translateY(10px); opacity: .6; } to { transform: translateY(0); opacity: 1; } }
        .confirm-modal-header {
            padding: 16px 20px;
            font-weight: 700;
            color: #333;
            border-bottom: 1px solid #eee;
        }
        .confirm-modal-body {
            padding: 16px 20px;
            color: #333;
            line-height: 1.6;
            white-space: pre-line;
        }
        .confirm-modal-footer {
            padding: 12px 16px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            background: #fafafa;
            border-top: 1px solid #eee;
        }
        .btn {
            height: 40px;
            padding: 0 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
            font-weight: 600;
        }
        .btn.primary {
            background: #E95473;
            color: #fff;
            border-color: #E95473;
        }
        .btn:hover { filter: brightness(0.98); }
    </style>
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="logo">
        <a th:href="@{/home}"><h1>FIAMA</h1></a>
    </div>

    <nav class="nav-links">
        <a th:href="@{/home}">Trang chủ</a>
        <a th:href="@{/product}">Sản phẩm</a>
        <a href="#">Liên hệ</a>
    </nav>

    <div class="utility-nav">
        <div th:if="${isLoggedIn}" class="user-dropdown">
            <a href="#" class="user-link"><i class="fas fa-user"></i><span th:text="${userDisplayName}">User</span></a>
            <div class="dropdown-menu">
                <a th:href="@{/account}">Tài khoản</a>
                <a th:href="@{/logout}">Đăng xuất</a>
            </div>
        </div>

        <!-- Safe check for not logged in -->
        <a th:if="${isLoggedIn != true}" th:href="@{/login}" class="user-link">
            <i class="fas fa-user"></i>
            <span>Đăng nhập</span>
        </a>

        <a th:href="@{/cart}" class="cart-icon-wrapper">
            <i class="fas fa-shopping-bag"></i>
            <span class="cart-count" id="cartCount" th:text="${cartItemCount != null ? cartItemCount : '0'}">0</span>
        </a>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="cart-container">
        <h1 class="cart-title">Giỏ hàng của tôi</h1>

        <!-- Empty Cart State (no Thymeleaf conditional that uses null) -->
        <div class="cart-empty" id="emptyCart" style="display:none;">
            <div class="empty-cart-icon"><i class="fas fa-shopping-bag"></i></div>
            <p class="empty-cart-message">Giỏ hàng trống</p>
            <a th:href="@{/home}" class="continue-browsing">Tiếp tục mua sắm</a>
        </div>

        <!-- Cart with Items -->
        <div class="cart-with-items" id="cartWithItems" style="display:none;">
            <div class="cart-items-section">
                <div class="cart-items" id="cartItemsList">
                    <!-- JS will inject items here -->
                </div>

                <div class="cart-actions">
                    <button class="update-cart-btn" id="updateCartBtn">Cập nhật giỏ hàng</button>
                </div>
            </div>

            <div class="cart-summary">
                <h2 class="summary-title">Tổng giỏ hàng</h2>
                <div class="checkout-info">
                    <h3>Thông tin người nhận</h3>
                    <div>
                        <label for="recipientName">Tên người nhận <span style="color:#e95473">*</span></label>
                        <input type="text" id="recipientName" placeholder="Nhập tên người nhận"
                               th:value="${defaultRecipientName}">
                    </div>
                    <div>
                        <label for="shippingAddress">Địa chỉ giao hàng <span style="color:#e95473">*</span></label>
                        <textarea id="shippingAddress" rows="3" placeholder="Nhập địa chỉ giao hàng"
                                  th:text="${defaultShippingAddress != null ? defaultShippingAddress : ''}"></textarea>
                    </div>
                    <p class="checkout-error" id="checkoutError" style="display:none;"></p>
                </div>
                <div class="summary-row"><span>Tạm tính</span><span class="subtotal">₫0</span></div>
                <div class="summary-row"><span>Phí vận chuyển</span><span class="shipping">₫15.000</span></div>
                <div class="summary-row"><span>Thuế VAT</span><span class="vat">₫0</span></div>
                <div class="summary-divider"></div>
                <div class="summary-row total-row"><span>Tổng cộng</span><span class="total">₫0</span></div>
                <button class="checkout-btn" id="checkoutBtn"><span>Đặt hàng</span></button>
            </div>
        </div>
    </div>
</main>

<!-- Footer (kept short to avoid parse risk) -->
<footer class="footer">
    <div class="footer-content">
        <div class="footer-column"><h4>Giờ mở cửa</h4><p>Thứ 2 - Thứ 6: 8:00 - 22:00</p></div>
        <div class="footer-column"><h4>Liên hệ</h4><p><i class="fas fa-phone"></i> +84 123 456 789</p></div>
        <div class="footer-column footer-center-column"><div class="footer-logo-center">FIAMA</div></div>
    </div>
</footer>

<!-- Toast -->
<div class="toast" id="toast" style="display:none;"><i class="fas fa-check-circle"></i><span>Đã cập nhật!</span></div>

<!-- Custom Confirm Modal -->
<div class="confirm-modal" id="checkoutConfirmModal" aria-modal="true" role="dialog" aria-labelledby="confirmTitle">
    <div class="confirm-modal-content">
        <div class="confirm-modal-header" id="confirmTitle">Xác nhận đặt hàng</div>
        <div class="confirm-modal-body" id="confirmMessage"></div>
        <div class="confirm-modal-footer">
            <button type="button" class="btn" id="confirmCancelBtn">Hủy</button>
            <button type="button" class="btn primary" id="confirmOkBtn">Đồng ý</button>
        </div>
    </div>
    <!-- click backdrop to cancel -->
</div>

<!-- External scripts (use th:src so Thymeleaf resolves location) -->
<script th:src="@{/js/cart-utils.js}"></script>
<script th:src="@{/js/cart.js}"></script>
</body>
</html>